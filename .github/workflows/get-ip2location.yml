name: Get IP2Location-Lite database

on:
  workflow_dispatch:
  schedule:
    - cron: "20 4 1,15 * *"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y csvkit
          pip install ip2location-python-csv-converter

      - name: Get IP2Location-Lite database
        env:
          DOWNLOAD_TOKEN: ${{ secrets.IP2LOCATION_DOWNLOAD_TOKEN }}
        run: |
          curl -sSL "https://www.ip2location.com/download/?token=${DOWNLOAD_TOKEN}&file=DB1LITECSV" | tar -xz -C IP2LOCATION-LITE-DB1
      
      - name: Convert database from numeric to CIDR
        run: |
          ip2location-csv-converter -cidr -replace IP2LOCATION-LITE-DB1/IP2LOCATION-LITE-DB1.CSV IP2LOCATION-LITE-DB1.CIDR.CSV

      - name: Extract Countries IPs
        run: |
          mkdir -p ip2location
          awk -F"," 'NR>1 {print $2}' IP2LOCATION-LITE-DB1.CIDR.CSV | sort -u > countries.txt
          while read l; do
            csvgrep -c 2 -m "$l" IP2LOCATION-LITE-DB1.CIDR.CSV | csvcut -c 1 | sed '1d' > "ip2location/$l.txt"
          done < countries.txt

      - name: Push assets to ip2location branch
        run: |
          cd ip2location || exit 1
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b ip2location
          git add .
          git commit -m "${{ github.run_id }}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin ip2location
